<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>doit.dependency</title>
    
          <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../_static/theme.css " type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../_static/theme-vendors.js"></script> -->
      <script src="../../_static/theme.js" defer></script>
      <link rel="canonical" href="https://pydoit.org/_modules/doit/dependency.html" />
    
      <link rel="shortcut icon" href="../../_static/favico.ico"/>
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../contents.html" class="home-link">
    
      <img class="logo" src="../../_static/doit-logo-small.png" alt="logo"/>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">

  
    <div class="nav-item">
      <a href="../../contents.html#getting-started"
         class="nav-link ">
         getting started
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../contents.html#guide"
         class="nav-link ">
         guide
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../contents.html#project"
         class="nav-link ">
         project
      </a>
    </div>
  



  
    <div class="nav-item">
      <a href="https://twitter.com/pydoit"
        class="nav-link external">
          Twitter <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="https://github.com/pydoit/doit"
        class="nav-link external">
          Github <outboundlink></outboundlink>
      </a>
    </div>
  

    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            

  
    <div class="nav-item">
      <a href="../../contents.html#getting-started"
         class="nav-link ">
         getting started
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../contents.html#guide"
         class="nav-link ">
         guide
      </a>
    </div>
  
    <div class="nav-item">
      <a href="../../contents.html#project"
         class="nav-link ">
         project
      </a>
    </div>
  



  
    <div class="nav-item">
      <a href="https://twitter.com/pydoit"
        class="nav-link external">
          Twitter <outboundlink></outboundlink>
      </a>
    </div>
  
    <div class="nav-item">
      <a href="https://github.com/pydoit/doit"
        class="nav-link external">
          Github <outboundlink></outboundlink>
      </a>
    </div>
  

            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../contents.html#getting-started">getting started</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../usecases.html" class="reference internal ">Use Cases</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../tutorial-1.html" class="reference internal ">tutorial - python imports graph</a>
            

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../contents.html#guide">guide</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../install.html" class="reference internal ">Installing</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../tasks.html" class="reference internal ">Tasks</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../dependencies.html" class="reference internal ">Non-file dependencies</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../task-creation.html" class="reference internal ">More on Task creation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../cmd-run.html" class="reference internal ">Command line interface - run</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../cmd-other.html" class="reference internal ">sub-commands for task manipulation</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../configuration.html" class="reference internal ">Configuration</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../task-args.html" class="reference internal ">Passing arguments from the command line</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../globals.html" class="reference internal ">Globals - accessing doit internals</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../uptodate.html" class="reference internal ">custom up-to-date</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../tools.html" class="reference internal ">Tools & Integrations</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../extending.html" class="reference internal ">Extending doit</a>
            

            
          </li>

        
      </ul>
    </div>
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../contents.html#project">project</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../support.html" class="reference internal ">Support</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../changes.html" class="reference internal ">Changes</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../stories.html" class="reference internal ">Success Stories</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../faq.html" class="reference internal ">FAQ</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../related.html" class="reference internal ">Related Projects</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>

  
    <div style="margin-bottom: 0px; padding:1rem; background-color: #2980B9; color:#fcfcfc;">
      <h3>Donate</h3>
      <p>If you find <em>doit</em> useful, please consider supporting the maintainer with a donation.</p>
      <p><em>doit</em> is 100% open-source and maintained by individuals without any company backing it... Your donation keeps the project healthy and maintained.</p>
    </div>

    <div style="text-align:center; padding:1rem; color:black;background-color:#fcfcfc; margin-bottom:2rem;">
      <h4 style="margin-bottom:5px;margin-top:5px;">OpenCollective</h4>
      <div>
        <object type="image/svg+xml" data="https://opencollective.com/doit/tiers/backers.svg?avatarHeight=60&width=200"></object>
      </div>

      <hr style="margin-top:5px;">
      <h4 style="margin-bottom:20px;">Paypal</h4>
      <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" style="margin:auto;">
        <input type="hidden" name="cmd" value="_s-xclick">
        <input type="hidden" name="hosted_button_id" value="GFU3BPVN586A6">
        <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
        <img alt="" border="0" src="https://www.paypalobjects.com/pt_BR/i/scr/pixel.gif" width="1" height="1" style="visibility:hidden;">
      </form>
    </div>
    <br>
  

        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../contents.html">Docs</a> &raquo;</li>
    
      <li><a href="../index.html">Module code</a> &raquo;</li>
    
    <li>doit.dependency</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <h1>Source code for doit.dependency</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Manage (save/check) task dependency-on-files data.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">dbm</span> <span class="kn">import</span> <span class="n">dumb</span>
<span class="kn">import</span> <span class="nn">dbm</span> <span class="k">as</span> <span class="nn">ddbm</span>

<span class="c1"># uncomment imports below to run tests on all dbm backends...</span>
<span class="c1">#import dumbdbm as ddbm</span>
<span class="c1">#import dbm as ddbm</span>
<span class="c1">#import gdbm as ddbm</span>

<span class="c1"># note: to check which DBM backend is being used (in py2):</span>
<span class="c1">#       &gt;&gt;&gt; anydbm._defaultmod</span>



<span class="k">class</span> <span class="nc">DatabaseException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception class for whatever backend exception&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">get_md5</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return md5 from string or unicode&quot;&quot;&quot;</span>
    <span class="n">byte_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">byte_data</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_file_md5</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the md5 sum from file content.</span>

<span class="sd">    @param path: (string) file path</span>
<span class="sd">    @return: (string) md5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_data</span><span class="p">:</span>
        <span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">block_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">md5</span><span class="o">.</span><span class="n">block_size</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">file_data</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">block_size</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">JSONCodec</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;default implmentation for codec used to save individual task&#39;s data&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecoder</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">JsonDB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Backend using a single text file with JSON content&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">codec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open/create a DB file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;load db content from file&quot;&quot;&quot;</span>
        <span class="n">db_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">db_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                <span class="c1"># file contains corrupted json data</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                       <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Invalid JSON data in </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                       <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s2">&quot;To fix this problem, you can just remove the &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;corrupted file, a new one will be generated.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">error</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span><span class="p">,)</span>
                <span class="k">raise</span> <span class="n">DatabaseException</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">db_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;save DB content in file&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">db_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">db_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">dependency</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store value in the DB.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">][</span><span class="n">dependency</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">dependency</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get value stored in the DB.</span>

<span class="sd">        @return: (string) or (None) if entry not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dependency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">in_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;@return bool if task_id is in DB&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>


    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove saved dependencies from DB for taskId&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove saved dependencies from DB for all tasks&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="p">{}</span>



<span class="k">class</span> <span class="nc">DbmDB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Backend using a DBM file with individual values encoded in JSON</span>

<span class="sd">    On initialization all items are read from DBM file and loaded on ``_dbm``.</span>
<span class="sd">    During execution whenever an item is read (``get`` method) the `json` value</span>
<span class="sd">    is cached on ``_db``.</span>
<span class="sd">    If an item is modified ``_db`` is update and the `id` is added</span>
<span class="sd">    to the `dirty` set. Only on ``dump`` all dirty items values are encoded</span>
<span class="sd">    in json into ``_dbm`` and the DBM file is saved.</span>

<span class="sd">    :ivar str name: file name/path</span>
<span class="sd">    :ivar dbm _dbm: items with json encoded values</span>
<span class="sd">    :ivar dict _db: items with python-dict as value</span>
<span class="sd">    :ivar set dirty: id of modified tasks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DBM_CONTENT_ERROR_MSG</span> <span class="o">=</span> <span class="s1">&#39;db type could not be determined&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">codec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open/create a DB file&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span> <span class="o">=</span> <span class="n">ddbm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ddbm</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DBM_CONTENT_ERROR_MSG</span><span class="p">:</span>
                <span class="c1"># When a corrupted/old format database is found</span>
                <span class="c1"># suggest the user to just remove the file</span>
                <span class="n">new_message</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;Dependencies file in </span><span class="si">%(filename)s</span><span class="s1"> seems to use &#39;</span>
                    <span class="s1">&#39;an old format or is corrupted.</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="s1">&#39;To fix the issue you can just remove the database file(s) &#39;</span>
                    <span class="s1">&#39;and a new one will be generated.&#39;</span>
                    <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)})</span>
                <span class="k">raise</span> <span class="n">DatabaseException</span><span class="p">(</span><span class="n">new_message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Re-raise any other exceptions</span>
                <span class="k">raise</span> <span class="n">DatabaseException</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;save/close DBM file&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">dependency</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store value in the DB.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">][</span><span class="n">dependency</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_in_dbm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        should be just::</span>
<span class="sd">          return key in self._dbm</span>

<span class="sd">         for get()/set() key is convert to bytes but not for &#39;in&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span>


    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">dependency</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get value stored in the DB.</span>

<span class="sd">        :return: string or None if entry not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># optimization, just try to get it without checking it exists</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dependency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">task_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">task_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dependency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">in_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;@return bool if task_id is in DB&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_dbm</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span> <span class="ow">or</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span>


    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove saved dependencies from DB for taskId&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_dbm</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">remove_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove saved dependencies from DB for all tasks&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dumb dbm always opens file in update mode</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span><span class="p">,</span> <span class="n">dumb</span><span class="o">.</span><span class="n">_Database</span><span class="p">):</span> <span class="c1"># pragma: no cover</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># gdbm can not be running on 2 instances on same thread</span>
        <span class="c1"># see https://bitbucket.org/schettino72/doit/issue/16/</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dbm</span> <span class="o">=</span> <span class="n">ddbm</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>



<span class="k">class</span> <span class="nc">SqliteDB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; sqlite3 json backend &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">codec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sqlite3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_sqlite3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open/create a sqlite3 DB file&quot;&quot;&quot;</span>

        <span class="c1"># Import sqlite here so it&#39;s only imported when required</span>
        <span class="kn">import</span> <span class="nn">sqlite3</span>
        <span class="k">def</span> <span class="nf">dict_factory</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;convert row to dict&quot;&quot;&quot;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">description</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">def</span> <span class="nf">converter</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>

        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_adapter</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">)</span>
        <span class="n">sqlite3</span><span class="o">.</span><span class="n">register_converter</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="n">converter</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">detect_types</span><span class="o">=</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_DECLTYPES</span><span class="o">|</span><span class="n">sqlite3</span><span class="o">.</span><span class="n">PARSE_COLNAMES</span><span class="p">,</span>
            <span class="n">isolation_level</span><span class="o">=</span><span class="s1">&#39;DEFERRED&#39;</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">dict_factory</span>
        <span class="n">sqlscript</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            create table if not exists doit (</span>
<span class="s2">                task_id text not null primary key,</span>
<span class="s2">                task_data json</span>
<span class="s2">            );&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sqlscript</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">DatabaseError</span> <span class="k">as</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">new_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;Dependencies file in </span><span class="si">%(filename)s</span><span class="s1"> seems to use &#39;</span>
                <span class="s1">&#39;an bad format or is corrupted.</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="s1">&#39;To fix the issue you can just remove the database file(s) &#39;</span>
                <span class="s1">&#39;and a new one will be generated.&#39;</span>
                <span class="s1">&#39;Original error: </span><span class="si">%(msg)s</span><span class="s1">&#39;</span>
                <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">)})</span>
            <span class="k">raise</span> <span class="n">DatabaseException</span><span class="p">(</span><span class="n">new_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">dependency</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get value stored in the DB.</span>

<span class="sd">        @return: (string) or (None) if entry not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dependency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_task_data</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dependency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_task_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select task_data from doit where task_id=?&#39;</span><span class="p">,</span>
                                  <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;task_data&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">data</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">dependency</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Store value in the DB.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">task_id</span><span class="p">][</span><span class="n">dependency</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">in_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select task_id from doit where task_id=?&#39;</span><span class="p">,</span>
                              <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span><span class="o">.</span><span class="n">fetchone</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;save/close sqlite3 DB file&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;insert or replace into doit values (?,?)&#39;</span><span class="p">,</span>
                               <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">task_id</span><span class="p">])))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove saved dependencies from DB for taskId&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;delete from doit where task_id=?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">remove_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove saved dependencies from DB for all task&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;delete from doit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">FileChangedChecker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base checker for dependencies, must be inherited.&quot;&quot;&quot;</span>

    <span class="n">CheckerError</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">error</span>

    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">file_stat</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if file in file_path is modified from previous &quot;state&quot;.</span>

<span class="sd">        @param file_path (string): file path</span>
<span class="sd">        @param file_stat: result of os.stat() of file_path</span>
<span class="sd">        @param state: state that was previously saved with ``get_state()``</span>
<span class="sd">        @returns (bool): True if dep is modified</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">current_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the state of a task after it has been successfully executed.</span>

<span class="sd">        @param dep (str): path of the dependency file.</span>
<span class="sd">        @param current_state (tuple): the current state, saved from a previous</span>
<span class="sd">            execution of the task (None if the task was never run).</span>
<span class="sd">        @returns: the new state. Return None if the state is unchanged.</span>

<span class="sd">        The parameter `current_state` is passed to allow speed optimization,</span>
<span class="sd">        see MD5Checker.get_state().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">MD5Checker</span><span class="p">(</span><span class="n">FileChangedChecker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;MD5 checker, uses the md5sum.</span>

<span class="sd">    This is the default checker used by doit.</span>

<span class="sd">    As an optimization the check uses (timestamp, file-size, md5).</span>
<span class="sd">    If the timestamp is the same it considers that the file has the same</span>
<span class="sd">    content. If file size is different its content certainly is modified.</span>
<span class="sd">    Finally the md5 is used for a different timestamp with the same size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">check_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">file_stat</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if file in file_path is modified from previous &quot;state&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timestamp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">file_md5</span> <span class="o">=</span> <span class="n">state</span>

        <span class="c1"># 1 - if timestamp is not modified file is the same</span>
        <span class="k">if</span> <span class="n">file_stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">==</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># 2 - if size is different file is modified</span>
        <span class="k">if</span> <span class="n">file_stat</span><span class="o">.</span><span class="n">st_size</span> <span class="o">!=</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># 3 - check md5</span>
        <span class="k">return</span> <span class="n">file_md5</span> <span class="o">!=</span> <span class="n">get_file_md5</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">current_state</span><span class="p">):</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
        <span class="c1"># time optimization. if dep is already saved with current</span>
        <span class="c1"># timestamp skip calculating md5</span>
        <span class="k">if</span> <span class="n">current_state</span> <span class="ow">and</span> <span class="n">current_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
        <span class="n">md5</span> <span class="o">=</span> <span class="n">get_file_md5</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">md5</span>


<span class="k">class</span> <span class="nc">TimestampChecker</span><span class="p">(</span><span class="n">FileChangedChecker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checker that use only the timestamp.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">check_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">file_stat</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">file_stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">!=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">current_state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;@returns float: mtime for file `dep`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>


<span class="c1"># name of checkers class available</span>
<span class="n">CHECKERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;md5&#39;</span><span class="p">:</span> <span class="n">MD5Checker</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">TimestampChecker</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">DependencyStatus</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Result object for Dependency.get_status.</span>

<span class="sd">    @ivar status: (str) one of &quot;run&quot;, &quot;up-to-date&quot; or &quot;error&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_log</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_log</span> <span class="o">=</span> <span class="n">get_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;up-to-date&#39;</span>
        <span class="c1"># save reason task is not up-to-date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reasons</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_reason</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets state and append reason for not being up-to-date</span>
<span class="sd">        :return boolean: processing should be interrupted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reasons</span><span class="p">[</span><span class="n">reason</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log</span>

    <span class="k">def</span> <span class="nf">set_reason</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets state and reason for not being up-to-date</span>
<span class="sd">        :return boolean: processing should be interrupted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;run&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reasons</span><span class="p">[</span><span class="n">reason</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_log</span>

    <span class="k">def</span> <span class="nf">get_error_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return str with error message&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_reason</span>



<div class="viewcode-block" id="Dependency"><a class="viewcode-back" href="../../globals.html#doit.dependency.Dependency">[docs]</a><span class="k">class</span> <span class="nc">Dependency</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Manage tasks dependencies.</span>

<span class="sd">    Each dependency is saved in &quot;db&quot;. There are several &quot;db&quot; backends.</span>
<span class="sd">    It uses a Key-Value format where the key is task-name</span>
<span class="sd">    and value is a dictionary.</span>
<span class="sd">    Each task has a dictionary where keys are `dependency`&#39;s (absolute file path),</span>
<span class="sd">    and the value is the dependency signature.</span>
<span class="sd">    Apart from dependencies other values are also saved on the task dictionary:</span>

<span class="sd">    * ``_values_:`` task&#39;s values</span>
<span class="sd">    * ``result:`` task result</span>

<span class="sd">    And also some internal doit attributes:</span>

<span class="sd">    * ``ignore:``</span>
<span class="sd">    * ``deps:``</span>
<span class="sd">    * ``checker:``</span>

<span class="sd">    Those can be accessed with generic DB ``get()``, see below...</span>

<span class="sd">    :ivar string name: filepath of the DB file</span>
<span class="sd">    :ivar bool _closed: DB was flushed to file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_class</span><span class="p">,</span> <span class="n">backend_name</span><span class="p">,</span> <span class="n">checker_cls</span><span class="o">=</span><span class="n">MD5Checker</span><span class="p">,</span>
                 <span class="n">codec_cls</span><span class="o">=</span><span class="n">JSONCodec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checker</span> <span class="o">=</span> <span class="n">checker_cls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_class</span> <span class="o">=</span> <span class="n">db_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">db_class</span><span class="p">(</span><span class="n">backend_name</span><span class="p">,</span> <span class="n">codec</span><span class="o">=</span><span class="n">codec_cls</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">remove</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">remove_all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">in_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write DB in file&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="c1">####### task specific</span>

    <span class="k">def</span> <span class="nf">save_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">result_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;save info after a task is successfully executed</span>

<span class="sd">        :param str result_hash: explicitly set result_hash</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># save task values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;_values_:&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1"># save task result md5</span>
        <span class="k">if</span> <span class="n">result_hash</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">result_hash</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;result:&quot;</span><span class="p">,</span> <span class="n">get_md5</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">))</span>

        <span class="c1"># file-dep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;checker:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">file_dep</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dep</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="c1"># save list of file_deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;deps:&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">file_dep</span><span class="p">))</span>

<div class="viewcode-block" id="Dependency.get_values"><a class="viewcode-back" href="../../globals.html#doit.dependency.Dependency.get_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get all saved values from a task</span>

<span class="sd">        :return dict:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="s1">&#39;_values_:&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span> <span class="ow">or</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="Dependency.get_value"><a class="viewcode-back" href="../../globals.html#doit.dependency.Dependency.get_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">key_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get saved value from task</span>

<span class="sd">        :param str task_id:</span>
<span class="sd">        :param str key_name: key result dict of the value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
            <span class="c1"># FIXME do not use generic exception</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;taskid &#39;</span><span class="si">%s</span><span class="s2">&#39; has no computed value!&quot;</span> <span class="o">%</span> <span class="n">task_id</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Invalid arg name. Task &#39;</span><span class="si">%s</span><span class="s2">&#39; has no value for &#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">key_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="n">key_name</span><span class="p">]</span></div>

<div class="viewcode-block" id="Dependency.get_result"><a class="viewcode-back" href="../../globals.html#doit.dependency.Dependency.get_result">[docs]</a>    <span class="k">def</span> <span class="nf">get_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get the result saved from a task</span>

<span class="sd">        :return (dict or md5sum):</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span> <span class="s1">&#39;result:&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">remove_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;remove saved info from task&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;mark task to be ignored&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ignore:&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">status_is_ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;check if task is marked to be ignored&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;ignore:&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">tasks_dict</span><span class="p">,</span> <span class="n">get_log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if task is up to date. set task.dep_changed</span>

<span class="sd">        If the checker class changed since the previous run, the task is</span>
<span class="sd">        deleted, to be sure that its state is not re-used.</span>

<span class="sd">        @param task: (Task)</span>
<span class="sd">        @param tasks_dict: (dict: Task) passed to objects used on uptodate</span>
<span class="sd">        @param get_log: (bool) if True, adds all reasons to the return</span>
<span class="sd">                               object why this file will be rebuild.</span>
<span class="sd">        @return: (DependencyStatus) a status object with possible status</span>
<span class="sd">                                    values up-to-date, run or error</span>

<span class="sd">        task.dep_changed (list-strings): file-dependencies that are not</span>
<span class="sd">        up-to-date if task not up-to-date because of a target, returned value</span>
<span class="sd">        will contain all file-dependencies regardless they are up-to-date</span>
<span class="sd">        or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">DependencyStatus</span><span class="p">(</span><span class="n">get_log</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">dep_changed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># check uptodate bool/callables</span>
        <span class="n">uptodate_result_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">utd</span><span class="p">,</span> <span class="n">utd_args</span><span class="p">,</span> <span class="n">utd_kwargs</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">uptodate</span><span class="p">:</span>
            <span class="c1"># if parameter is a callable</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">utd</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
                <span class="c1"># FIXME control verbosity, check error messages</span>
                <span class="c1"># 1) setup object with global info all tasks</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">utd</span><span class="p">,</span> <span class="n">UptodateCalculator</span><span class="p">):</span>
                    <span class="n">utd</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks_dict</span><span class="p">)</span>
                <span class="c1"># 2) add magic positional args for `task` and `values`</span>
                <span class="c1"># if present.</span>
                <span class="n">spec_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">utd</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">magic_args</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spec_args</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;task&#39;</span><span class="p">:</span>
                        <span class="n">magic_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;values&#39;</span><span class="p">:</span>
                        <span class="n">magic_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">magic_args</span> <span class="o">+</span> <span class="n">utd_args</span>
                <span class="c1"># 3) call it and get result</span>
                <span class="n">uptodate_result</span> <span class="o">=</span> <span class="n">utd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">utd_kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">utd</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">uptodate_result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                    <span class="n">utd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="c1"># parameter is a value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uptodate_result</span> <span class="o">=</span> <span class="n">utd</span>

            <span class="c1"># None means uptodate was not really calculated and should be</span>
            <span class="c1"># just ignored</span>
            <span class="k">if</span> <span class="n">uptodate_result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">uptodate_result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uptodate_result</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">uptodate_result</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_reason</span><span class="p">(</span><span class="s1">&#39;uptodate_false&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">utd</span><span class="p">,</span> <span class="n">utd_args</span><span class="p">,</span> <span class="n">utd_kwargs</span><span class="p">))</span>

        <span class="c1"># any uptodate check is false</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">get_log</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;run&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># no dependencies means it is never up to date.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">file_dep</span> <span class="ow">or</span> <span class="n">uptodate_result_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">set_reason</span><span class="p">(</span><span class="s1">&#39;has_no_dependencies&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">result</span>


        <span class="c1"># if target file is not there, task is not up to date</span>
        <span class="k">for</span> <span class="n">targ</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">targ</span><span class="p">):</span>
                <span class="n">task</span><span class="o">.</span><span class="n">dep_changed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">file_dep</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">add_reason</span><span class="p">(</span><span class="s1">&#39;missing_target&#39;</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># check for modified file_dep checker</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;checker:&#39;</span><span class="p">)</span>
        <span class="n">checker_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">previous</span> <span class="ow">and</span> <span class="n">previous</span> <span class="o">!=</span> <span class="n">checker_name</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">dep_changed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">file_dep</span><span class="p">)</span>
            <span class="c1"># remove all saved values otherwise they might be re-used by</span>
            <span class="c1"># some optimization on MD5Checker.get_state()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">set_reason</span><span class="p">(</span><span class="s1">&#39;checker_changed&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">checker_name</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># check for modified file_dep</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;deps:&#39;</span><span class="p">)</span>
        <span class="n">previous_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">previous</span><span class="p">)</span> <span class="k">if</span> <span class="n">previous</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">previous_set</span> <span class="ow">and</span> <span class="n">previous_set</span> <span class="o">!=</span> <span class="n">task</span><span class="o">.</span><span class="n">file_dep</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">get_log</span><span class="p">:</span>
                <span class="n">added_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">file_dep</span> <span class="o">-</span> <span class="n">previous_set</span><span class="p">))</span>
                <span class="n">removed_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">previous_set</span> <span class="o">-</span> <span class="n">task</span><span class="o">.</span><span class="n">file_dep</span><span class="p">))</span>
                <span class="n">result</span><span class="o">.</span><span class="n">set_reason</span><span class="p">(</span><span class="s1">&#39;added_file_dep&#39;</span><span class="p">,</span> <span class="n">added_files</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">set_reason</span><span class="p">(</span><span class="s1">&#39;removed_file_dep&#39;</span><span class="p">,</span> <span class="n">removed_files</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;run&#39;</span>

        <span class="c1"># list of file_dep that changed</span>
        <span class="n">check_modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">check_modified</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">file_dep</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">file_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
            <span class="k">except</span> <span class="bp">self</span><span class="o">.</span><span class="n">checker</span><span class="o">.</span><span class="n">CheckerError</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Dependent file &#39;</span><span class="si">{}</span><span class="s2">&#39; does not exist.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_reason</span> <span class="o">=</span> <span class="n">error_msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">add_reason</span><span class="p">(</span><span class="s1">&#39;missing_file_dep&#39;</span><span class="p">,</span> <span class="n">dep</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">check_modified</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="n">file_stat</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
                    <span class="n">changed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">dep_changed</span> <span class="o">=</span> <span class="n">changed</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">set_reason</span><span class="p">(</span><span class="s1">&#39;changed_file_dep&#39;</span><span class="p">,</span> <span class="n">changed</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>



<span class="c1">#############</span>

<span class="k">class</span> <span class="nc">UptodateCalculator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for &#39;uptodate&#39; that need access to all tasks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Dependency._get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_dict</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># dict with all tasks</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep_manager</span><span class="p">,</span> <span class="n">tasks_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;@param&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span> <span class="o">=</span> <span class="n">dep_manager</span><span class="o">.</span><span class="n">_get</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_dict</span> <span class="o">=</span> <span class="n">tasks_dict</span>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2008-2020, Eduardo Schettino.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
  
    
  
    
      <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-29887834-3', 'auto');
        ga('send', 'pageview');
      </script>
    
  

  </body>
</html>