<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>More on dependencies &mdash; doit - automation tool</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.30',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favico.ico"/>
    <link rel="top" title="doit - automation tool" href="contents.html" />
    <link rel="next" title="Command line interface - run" href="cmd_run.html" />
    <link rel="prev" title="Tasks" href="tasks.html" />
<style>
  body {
    font-size: 16px;
  }

  div.topic {
    padding: 0;
    background-color: #F8F4A6;
    border: 1px solid #D8D486;
  }

  div.topic p.first {
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    background-color: #E8E496;
    border-bottom: 1px solid #C8C476;
  }

  div.topic p {
    margin: 0.5em 1em 0.5em 1em;
  }

  p.topic-title {
    display: run-in;
    margin-right: 15px;
  }

  a.external-link {
    background: url(_static/external.png) center right no-repeat;
    padding-right: 13px;
  }

  div.related ul li a.external-link {
    padding-right: 13px;
  }

  .sidebartext {
    font-size: 75%;
    line-height: 130%;
  }

</style>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29887834-3', 'auto');
  ga('send', 'pageview');
</script>



  </head>
  <body role="document">
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 50px">
<img src="_static/doit.png" alt="doit logo" />
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="cmd_run.html" title="Command line interface - run"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="tasks.html" title="Tasks"
             accesskey="P">previous</a> |</li>
  <li><a href="index.html">Home</a>&nbsp;|&nbsp;</li>
  <li><a href="contents.html">Documentation</a>&nbsp;|&nbsp;</li>
  <!-- TODO news -->
  <li><a class="external-link" href="https://github.com/pydoit/doit">Code</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://github.com/pydoit/doit/issues">Issues</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://pypi.python.org/pypi/doit">Download</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://groups.google.co.in/group/python-doit">Forum</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://twitter.com/py_doit">Twitter</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">More on dependencies</a><ul>
<li><a class="reference internal" href="#uptodate">uptodate</a></li>
<li><a class="reference internal" href="#doit-up-to-date-definition">doit up-to-date definition</a></li>
<li><a class="reference internal" href="#task-dependency">task-dependency</a><ul>
<li><a class="reference internal" href="#groups">groups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#calculated-dependencies">calculated-dependencies</a></li>
<li><a class="reference internal" href="#setup-task">setup-task</a><ul>
<li><a class="reference internal" href="#teardown">teardown</a></li>
</ul>
</li>
<li><a class="reference internal" href="#saving-computed-values">saving computed values</a></li>
<li><a class="reference internal" href="#getargs">getargs</a></li>
</ul>
</li>
</ul>




<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>


<h3>Funding Campaign</h3>
<iframe src="https://www.indiegogo.com/project/doit-python-automation-tool-release-0-30/embedded/2922409" width="222px" height="445px" frameborder="0" scrolling="no"></iframe>


<h3>Sponsors</h3>

<div>
  <a href="http://pygarden.com"><img src="_static/pygarden.png" alt="pygarden.com logo" style="display:block; margin:auto;"/></a><br/>
</div>


<h3>Donate</h3>


<div>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" style="margin:auto;">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="GFU3BPVN586A6">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/pt_BR/i/scr/pixel.gif" width="1" height="1">
</form>
</div>

<br/>

<div class="sidebartext">
If you use <em>doit</em> and think it is a useful project. Please consider to make a donation to support the developer/maintainer with maintanance tasks (bug fixes, merge patches, reply users) and further development.<br/>
</div>



<h3></h3>
<a href="http://python.org"><img src="_static/python-powered-w-100x40.png" alt="python logo"/></a><br/><br/>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="more-on-dependencies">
<h1>More on dependencies<a class="headerlink" href="#more-on-dependencies" title="Permalink to this headline">¶</a></h1>
<div class="section" id="uptodate">
<span id="attr-uptodate"></span><h2>uptodate<a class="headerlink" href="#uptodate" title="Permalink to this headline">¶</a></h2>
<p>Apart from file dependencies you can extend <cite>doit</cite> to support other ways
to determine if a task is up-to-date through the attribute <code class="docutils literal"><span class="pre">uptodate</span></code>.</p>
<p>This can be used in cases where you need to some kind of calculation to
determine if the task is up-to-date or not.</p>
<p><code class="docutils literal"><span class="pre">uptodate</span></code> is a list where each element can be True, False, None, a callable
or a command(string).</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">False</span></code> indicates that the task is NOT up-to-date</li>
<li><code class="docutils literal"><span class="pre">True</span></code> indicates that the task is up-to-date</li>
<li><code class="docutils literal"><span class="pre">None</span></code> values will just be ignored. This is used when the value is dynamically calculated</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>An <code class="docutils literal"><span class="pre">uptodate</span></code> value equal to <code class="docutils literal"><span class="pre">True</span></code> does not override others
up-to-date checks. It is one more way to check if task is <strong>not</strong> up-to-date.</p>
<p class="last">i.e. if uptodate==True but a file_dep changes the task is still
considered <strong>not</strong> up-to-date.</p>
</div>
<p>If an <code class="docutils literal"><span class="pre">uptodate</span></code> item is a string it will be executed on the shell.
If the process exits with the code <code class="docutils literal"><span class="pre">0</span></code>, it is considered as up-to-date.
All other values would be considered as not up-to-date.</p>
<p><code class="docutils literal"><span class="pre">uptodate</span></code> elements can also be a callable that will be executed on runtime
(not when the task is being created).
The section <code class="docutils literal"><span class="pre">custom-uptodate</span></code> will explain in details how to extend <cite>doit</cite>
writing your own callables for <code class="docutils literal"><span class="pre">uptodate</span></code>. This callables will typically
compare a value on the present time with a value calculated on the last
successful execution.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no guarantee <code class="docutils literal"><span class="pre">uptodate</span></code> callables or commands will be executed.
<cite>doit</cite> short-circuit the checks, if it is already determined that the
task is no <cite>up-to-date</cite> it will not execute remaining <code class="docutils literal"><span class="pre">uptodate</span></code> checks.</p>
</div>
<p><cite>doit</cite> includes several implementations to be used as <code class="docutils literal"><span class="pre">uptodate</span></code>.
They are all included in module <cite>doit.tools</cite> and will be discussed in detail
<a class="reference internal" href="uptodate.html#uptodate-api"><span class="std std-ref">later</span></a>:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="uptodate.html#result-dep"><span class="std std-ref">result_dep</span></a>: check if the result of another task
has changed</li>
<li><a class="reference internal" href="uptodate.html#run-once"><span class="std std-ref">run_once</span></a>: execute a task only once
(used for tasks without dependencies)</li>
<li><a class="reference internal" href="uptodate.html#timeout"><span class="std std-ref">timeout</span></a>: indicate that a task should &#8220;expire&#8221; after
a certain time interval</li>
<li><a class="reference internal" href="uptodate.html#config-changed"><span class="std std-ref">config_changed</span></a>: check for changes in
a &#8220;configuration&#8221; string or dictionary</li>
<li><a class="reference internal" href="uptodate.html#check-timestamp-unchanged"><span class="std std-ref">check_timestamp_unchanged()</span></a>: check access,
status change/create or modify timestamp of a given file/directory</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="doit-up-to-date-definition">
<span id="up-to-date-def"></span><h2>doit up-to-date definition<a class="headerlink" href="#doit-up-to-date-definition" title="Permalink to this headline">¶</a></h2>
<p>A task is <strong>not</strong> up-to-date if any of:</p>
<blockquote>
<div><ul class="simple">
<li>an <a class="reference internal" href="#attr-uptodate"><span class="std std-ref">uptodate</span></a> item is (or evaluates to) <cite>False</cite></li>
<li>a file is added to or removed from <cite>file_dep</cite></li>
<li>a <cite>file_dep</cite> changed since last successful execution</li>
<li>a <cite>target</cite> path does not exist</li>
<li>a task has no <cite>file_dep</cite> and <cite>uptodate</cite> item equal to <cite>True</cite></li>
</ul>
</div></blockquote>
<p>It means that if a task does not explicitly define any <em>input</em> (dependency)
it will never be considered <cite>up-to-date</cite>.</p>
<p>Note that since a <cite>target</cite> represents an <em>output</em> of the task,
a missing <cite>target</cite> is enough to determine that a task is not <cite>up-to-date</cite>.
But its existence by itself is not enough to mark a task <cite>up-to-date</cite>.</p>
<p>In some situations, it is useful to define a task with targets but no
dependencies. If you want to re-execute this task only when targets are missing
you must explicitly add a dependency: you could add a <code class="docutils literal"><span class="pre">uptodate</span></code> with <code class="docutils literal"><span class="pre">True</span></code>
value or use <a class="reference internal" href="uptodate.html#run-once"><span class="std std-ref">run_once()</span></a> to force at least one
execution managed by <cite>doit</cite>. Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">task_touch</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;touch foo.txt&#39;</span><span class="p">],</span>
        <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;foo.txt&#39;</span><span class="p">],</span>
        <span class="c1"># force doit to always mark the task</span>
        <span class="c1"># as up-to-date (unless target removed)</span>
        <span class="s1">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">],</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>Apart from <code class="docutils literal"><span class="pre">file_dep</span></code> and  <code class="docutils literal"><span class="pre">uptodate</span></code> used to determine if a task
is <cite>up-to-date</cite> or not,
<code class="docutils literal"><span class="pre">doit</span></code> also includes other kind of dependencies (introduced below)
to help you combine tasks
so they are executed in appropriate order.</p>
</div>
<div class="section" id="task-dependency">
<h2>task-dependency<a class="headerlink" href="#task-dependency" title="Permalink to this headline">¶</a></h2>
<p>It is used to enforce tasks are executed on the desired order.
By default tasks are executed on the same order as they were defined in
the <cite>dodo</cite> file. To define a dependency on another task use the
task name (whatever comes after <code class="docutils literal"><span class="pre">task_</span></code> on the function name) in the
&#8220;task_dep&#8221; attribute.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A <em>task-dependency</em> <strong>only</strong> indicates that another task should be &#8220;executed&#8221;
before itself. The task-dependency might not really be executed if it
is <em>up-to-date</em>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><em>task-dependencies</em> are <strong>not</strong> used to determine if a task is up-to-date or
not. If a task defines only <em>task-dependency</em> it will always be executed.</p>
</div>
<p>This example we make sure we include a file with the latest revision number of
the mercurial repository on the tar file.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">task_tar</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tar -cf foo.tar *&quot;</span><span class="p">],</span>
            <span class="s1">&#39;task_dep&#39;</span><span class="p">:[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span>
            <span class="s1">&#39;targets&#39;</span><span class="p">:[</span><span class="s1">&#39;foo.tar&#39;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">task_version</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hg tip --template &#39;</span><span class="si">{rev}</span><span class="s2">&#39; &gt; revision.txt&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> doit
<span class="go">.  version</span>
<span class="go">.  tar</span>
</pre></div>
</div>
<div class="section" id="groups">
<h3>groups<a class="headerlink" href="#groups" title="Permalink to this headline">¶</a></h3>
<p>You can define a group of tasks by adding tasks as dependencies and setting
its <cite>actions</cite> to <code class="docutils literal"><span class="pre">None</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">task_foo</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;echo foo&quot;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">task_bar</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;echo bar&quot;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">task_mygroup</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;task_dep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">]}</span>
</pre></div>
</div>
<p>Note that tasks are never executed twice in the same &#8220;run&#8221;.</p>
</div>
</div>
<div class="section" id="calculated-dependencies">
<span id="attr-calc-dep"></span><h2>calculated-dependencies<a class="headerlink" href="#calculated-dependencies" title="Permalink to this headline">¶</a></h2>
<p>Calculation of dependencies might be an expensive operation, so not suitable
to be done on load time by task-creators.
For this situation it is better to delegate
the calculation of dependencies to another task.
The task calculating dependencies must have a python-action returning a
dictionary with <cite>file_dep</cite>, <cite>task_dep</cite>, <cite>uptodate</cite> or another <cite>calc_dep</cite>.</p>
<p>On the example below <code class="docutils literal"><span class="pre">mod_deps</span></code> prints on the screen all direct dependencies
from a module. The dependencies itself are calculated on task <code class="docutils literal"><span class="pre">get_dep</span></code>
(note: get_dep has a fake implementation where the results are taken from a dict).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DOIT_CONFIG</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="n">MOD_IMPORTS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">],</span>
               <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">],</span>
               <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[],</span>
               <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span>
               <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="p">[]}</span>


<span class="k">def</span> <span class="nf">print_deps</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">task_mod_deps</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;task that depends on all direct imports&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">MOD_IMPORTS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">mod</span><span class="p">,</span>
               <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">print_deps</span><span class="p">,(</span><span class="n">mod</span><span class="p">,))],</span>
               <span class="s1">&#39;file_dep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">mod</span><span class="p">],</span>
               <span class="s1">&#39;calc_dep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;get_dep:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mod</span><span class="p">],</span>
               <span class="p">}</span>

<span class="k">def</span> <span class="nf">get_dep</span><span class="p">(</span><span class="n">mod</span><span class="p">):</span>
    <span class="c1"># fake implementation</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;file_dep&#39;</span><span class="p">:</span> <span class="n">MOD_IMPORTS</span><span class="p">[</span><span class="n">mod</span><span class="p">]}</span>
<span class="k">def</span> <span class="nf">task_get_dep</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;get direct dependencies for each module&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">MOD_IMPORTS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">mod</span><span class="p">,</span>
               <span class="s1">&#39;actions&#39;</span><span class="p">:[(</span><span class="n">get_dep</span><span class="p">,[</span><span class="n">mod</span><span class="p">])],</span>
               <span class="s1">&#39;file_dep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">mod</span><span class="p">],</span>
               <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="setup-task">
<h2>setup-task<a class="headerlink" href="#setup-task" title="Permalink to this headline">¶</a></h2>
<p>Some tasks may require some kind of environment setup.
In this case they can define a list of &#8220;setup&#8221; tasks.</p>
<ul class="simple">
<li>the setup-task will be executed only if the task is to be executed (not up-to-date)</li>
<li>setup-tasks are just normal tasks that follow all other task behavior</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A <em>task-dependency</em> is executed before checking if the task is up-to-date.
A <em>setup-task</em> is executed after the checking if the task is up-to-date and
it is executed only if the task is not up-to-date and will be executed.</p>
</div>
<div class="section" id="teardown">
<h3>teardown<a class="headerlink" href="#teardown" title="Permalink to this headline">¶</a></h3>
<p>Task may also define &#8216;teardown&#8217; actions.
These actions are executed after all tasks have finished their execution.
They are executed in reverse order their tasks were executed.</p>
<p>Example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">### task setup env. good for functional tests!</span>
<span class="n">DOIT_CONFIG</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
               <span class="s1">&#39;default_tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;withenvX&#39;</span><span class="p">,</span> <span class="s1">&#39;withenvY&#39;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;stop </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">task_setup_sample</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;setupX&#39;</span><span class="p">,</span> <span class="s1">&#39;setupY&#39;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
               <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))],</span>
               <span class="s1">&#39;teardown&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">stop</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,))],</span>
               <span class="p">}</span>

<span class="k">def</span> <span class="nf">task_withenvX</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">fin</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">):</span>
        <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">fin</span><span class="p">,</span>
               <span class="s1">&#39;actions&#39;</span><span class="p">:[</span><span class="s1">&#39;echo x </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fin</span><span class="p">],</span>
               <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;setup_sample:setupX&#39;</span><span class="p">],</span>
               <span class="p">}</span>

<span class="k">def</span> <span class="nf">task_withenvY</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:[</span><span class="s1">&#39;echo y&#39;</span><span class="p">],</span>
            <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;setup_sample:setupY&#39;</span><span class="p">],</span>
            <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> doit withenvX
<span class="go">.  setup_sample:setupX</span>
<span class="go">start setupX</span>
<span class="go">.  withenvX:c</span>
<span class="go">x c</span>
<span class="go">.  withenvX:b</span>
<span class="go">x b</span>
<span class="go">.  withenvX:a</span>
<span class="go">x a</span>
<span class="go">stop setupX</span>
<span class="gp">$</span> doit withenvY
<span class="go">.  setup_sample:setupY</span>
<span class="go">start setupY</span>
<span class="go">.  withenvY</span>
<span class="go">y</span>
<span class="go">stop setupY</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="saving-computed-values">
<h2>saving computed values<a class="headerlink" href="#saving-computed-values" title="Permalink to this headline">¶</a></h2>
<p>Tasks can save computed values by returning a dictionary on it&#8217;s python-actions.
The values must be JSON encodable.</p>
<p>A cmd-action can also save it&#8217;s output.
But for this you will need to explicitly import <cite>CmdAction</cite> and set its <cite>save_out</cite>
parameter with the <em>name</em> used to save the output in <em>values</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">doit.action</span> <span class="k">import</span> <span class="n">CmdAction</span>

<span class="k">def</span> <span class="nf">task_save_output</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">CmdAction</span><span class="p">(</span><span class="s2">&quot;echo x1&quot;</span><span class="p">,</span> <span class="n">save_out</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">)],</span>
        <span class="p">}</span>
<span class="c1"># The task values will contain: {&#39;out&#39;: u&#39;x1&#39;}</span>
</pre></div>
</div>
<p>These values can be used on <a class="reference internal" href="#uptodate">uptodate</a> and <a class="reference internal" href="#getargs">getargs</a>.
Check those sections for examples.</p>
</div>
<div class="section" id="getargs">
<h2>getargs<a class="headerlink" href="#getargs" title="Permalink to this headline">¶</a></h2>
<p><cite>getargs</cite> provides a way to use values computed from one task in another task.
The values are taken from &#8220;saved computed values&#8221;
(returned dict from a python-action).</p>
<p>For <em>cmd-action</em> use dictionary-based string formatting.</p>
<p>For <em>python-action</em> the action callable parameter names must match with keys
from <cite>getargs</cite>.</p>
<p><cite>getargs</cite> is a dictionary where the key is the argument name used on actions,
and the value is a tuple with 2 strings: task name, &#8220;value name&#8221;.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DOIT_CONFIG</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default_tasks&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;use_cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;use_python&#39;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">task_compute</span><span class="p">():</span>
   <span class="k">def</span> <span class="nf">comp</span><span class="p">():</span>
       <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
   <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">comp</span><span class="p">,)]}</span>


<span class="k">def</span> <span class="nf">task_use_cmd</span><span class="p">():</span>
   <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;echo x=</span><span class="si">%(x)s</span><span class="s1">, z=</span><span class="si">%(z)s</span><span class="s1">&#39;</span><span class="p">],</span>
           <span class="s1">&#39;getargs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span>
                       <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">)},</span>
           <span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
           <span class="p">}</span>


<span class="k">def</span> <span class="nf">task_use_python</span><span class="p">():</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">show_getargs</span><span class="p">],</span>
          <span class="s1">&#39;getargs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">),</span>
                      <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">)},</span>
          <span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="p">}</span>
<span class="k">def</span> <span class="nf">show_getargs</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;this is x:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;this is y:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
<p>The values are being passed on to a python-action you can pass the whole dict
by specifying the value name as <code class="docutils literal"><span class="pre">None</span></code>.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">task_compute</span><span class="p">():</span>
   <span class="k">def</span> <span class="nf">comp</span><span class="p">():</span>
       <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>
   <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">comp</span><span class="p">,)]}</span>


<span class="k">def</span> <span class="nf">show_getargs</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
   <span class="nb">print</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">task_args_dict</span><span class="p">():</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">show_getargs</span><span class="p">],</span>
          <span class="s1">&#39;getargs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)},</span>
          <span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="p">}</span>
</pre></div>
</div>
<p>If a group-task is used, the values from all its sub-tasks are passed as a dict.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">task_compute</span><span class="p">():</span>
   <span class="k">def</span> <span class="nf">comp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
       <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="n">x</span><span class="p">}</span>
   <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span>
          <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="p">]</span>
          <span class="p">}</span>
   <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span>
          <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="p">]</span>
          <span class="p">}</span>


<span class="k">def</span> <span class="nf">show_getargs</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="mi">12</span>

<span class="k">def</span> <span class="nf">task_args_dict</span><span class="p">():</span>
  <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">show_getargs</span><span class="p">],</span>
          <span class="s1">&#39;getargs&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;compute&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)},</span>
          <span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
          <span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">getargs</span></code> creates an implicit setup-task.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="cmd_run.html" title="Command line interface - run"
             >next</a></li>
        <li class="right" >
          <a href="tasks.html" title="Tasks"
             >previous</a> |</li>
  <li><a href="index.html">Home</a>&nbsp;|&nbsp;</li>
  <li><a href="contents.html">Documentation</a>&nbsp;|&nbsp;</li>
  <!-- TODO news -->
  <li><a class="external-link" href="https://github.com/pydoit/doit">Code</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://github.com/pydoit/doit/issues">Issues</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://pypi.python.org/pypi/doit">Download</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://groups.google.co.in/group/python-doit">Forum</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://twitter.com/py_doit">Twitter</a></li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2008-2015, Eduardo Schettino.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.3.
    </div>
  </body>
</html>