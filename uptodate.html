<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>custom uptodate &mdash; doit - automation tool</title>
    
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.25',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favico.ico"/>
    <link rel="top" title="doit - automation tool" href="index.html" />
    <link rel="next" title="Command line interface - run" href="cmd_run.html" />
    <link rel="prev" title="More on dependencies" href="dependencies.html" />
<style>
  div.topic {
    padding: 2px;
    background-color: #F8F4A6;
    border: none;
  }

  p.topic-title {
    display: run-in;
    margin-right: 15px;
  }

  a.external-link {
    background: url(_static/external.png) center right no-repeat;
    padding-right: 13px;
  }

  div.related ul li a.external-link {
    padding-right: 13px;
  }

</style>


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29887834-3']);
  _gaq.push(['_setDomainName', 'pydoit.org']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 50px">
<img src="_static/doit.png" alt="doit logo" />
</div>

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="cmd_run.html" title="Command line interface - run"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="dependencies.html" title="More on dependencies"
             accesskey="P">previous</a> |</li>
  <li><a href="index.html">Home</a>&nbsp;|&nbsp;</li>
  <li><a href="contents.html">Documentation</a>&nbsp;|&nbsp;</li>
  <!-- TODO news -->
  <li><a class="external-link" href="https://bitbucket.org/schettino72/doit/src">Code</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://bitbucket.org/schettino72/doit/issues?status=new&status=open">Issues</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://pypi.python.org/pypi/doit">Download</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://groups.google.co.in/group/python-doit">Forum</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">custom uptodate</a><ul>
<li><a class="reference internal" href="#result-dependency">result-dependency</a></li>
<li><a class="reference internal" href="#run-once">run-once</a></li>
<li><a class="reference internal" href="#timeout">timeout</a></li>
<li><a class="reference internal" href="#config-changed">config_changed</a></li>
<li><a class="reference internal" href="#check-timestamp-unchanged">check_timestamp_unchanged</a></li>
<li><a class="reference internal" href="#uptodate-api">uptodate API</a><ul>
<li><a class="reference internal" href="#example-run-once-implementation">Example: run-once implementation</a></li>
<li><a class="reference internal" href="#example-timeout-implementation">Example: timeout implementation</a></li>
<li><a class="reference internal" href="#example-result-dep-implementation">Example: result_dep implementation</a></li>
</ul>
</li>
</ul>
</li>
</ul>



<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>

<h3>Sponsors</h3>
<em>Your logo here</em>

<h3>Sponsor/Donate to <em>doit</em></h3>


<script data-gittip-username="schettino72"
        data-gittip-widget="button"
        src="//gttp.co/v1.js"></script>


<div style="margin-left:2em;">
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="BFF4G58USYPBA">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/pt_BR/i/scr/pixel.gif" width="1" height="1">
</form>
</div>
<br/>

<div style="font-size:75%">
Why Donate? Donations will be used to sponsor futher development of the project.<br/>
<br/>
For coorporate donations the logo of your company will be placed on this website side-bar (see above). For more information please contact <em>schettino72</em>&#64<span>gmail.com</span><br/>
</div>




<h3></h3>
<a href="http://python.org"><img src="_static/python-powered-w-100x40.png" /></a><br/><br/>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="custom-uptodate">
<h1>custom uptodate<a class="headerlink" href="#custom-uptodate" title="Permalink to this headline">¶</a></h1>
<p>The basics of <cite>uptodate</cite> was already introduced. Here we look in more
detail into some implementations shipped with <cite>doit</cite>. And the API used by those.</p>
<div class="section" id="result-dependency">
<h2>result-dependency<a class="headerlink" href="#result-dependency" title="Permalink to this headline">¶</a></h2>
<p>In some cases you can not determine if a task is &#8220;up-to-date&#8221; only based on
input files, the input could come from a database or an external process.
<em>doit</em> defines a &#8220;result-dependency&#8221; to deal with these cases without need to
create an intermediate file with the results of the process.</p>
<p>i.e. Suppose you want to send an email every time you run <em>doit</em> on a mercurial
repository that contains a new revision number.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">doit.tools</span> <span class="kn">import</span> <span class="n">result_dep</span>

<span class="k">def</span> <span class="nf">task_version</span><span class="p">():</span>
	<span class="k">return</span> <span class="p">{</span><span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;hg tip --template &#39;{rev}:{node}&#39;&quot;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">task_send_email</span><span class="p">():</span>
	<span class="k">return</span> <span class="p">{</span><span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;echo &quot;TODO: send an email&quot;&#39;</span><span class="p">],</span>
	        <span class="s">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">result_dep</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">)]}</span>
</pre></div>
</div>
<p>Note the <cite>result_dep</cite> with the name of the task (&#8216;version&#8217;). <cite>doit</cite> will keep
track of the output of the task <em>version</em> and will execute <em>send_email</em> only
when the mercurial repository has a new version since last
time <em>doit</em> was executed.</p>
<p>The &#8220;result&#8221; from the dependent task compared between different runs is given
by its last action.
The content for python-action is the value of the returned string or dict.
For cmd-actions it is the output send to stdout plus stderr.</p>
<p><cite>result_dep</cite> also supports group-tasks. In this case it will check that the
result of all subtasks did not change. And also the existing sub-tasks are
the same.</p>
</div>
<div class="section" id="run-once">
<h2>run-once<a class="headerlink" href="#run-once" title="Permalink to this headline">¶</a></h2>
<p>Sometimes there is no dependency for a task but you do not want to execute it
all the time. With &#8220;run_once&#8221; the task will not be executed again after the first
successful run. This is mostly used together with targets.</p>
<p>Suppose you need to download something from internet.
There is no dependency, but you do not want to download it many times.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">doit.tools</span> <span class="kn">import</span> <span class="n">run_once</span>

<span class="k">def</span> <span class="nf">task_get_pylogo</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://python.org/images/python-logo.gif&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;wget </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">],</span>
            <span class="s">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;python-logo.gif&quot;</span><span class="p">],</span>
            <span class="s">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">run_once</span><span class="p">],</span>
            <span class="p">}</span>
</pre></div>
</div>
<p>Note that even with <em>run_once</em> the file will be downloaded again in case the target is removed.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> doit
<span class="go">.  get_pylogo</span>
<span class="gp">$</span> doit
<span class="go">-- get_pylogo</span>
<span class="gp">$</span> rm python-logo.gif
<span class="gp">$</span> doit
<span class="go">.  get_pylogo</span>
</pre></div>
</div>
</div>
<div class="section" id="timeout">
<h2>timeout<a class="headerlink" href="#timeout" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">timeout</span></tt> is used to expire a task after a certain time interval.</p>
<p>i.e. You want to re-execute a task only if the time elapsed since the last
time it was executed is bigger than 5 minutes.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">doit.tools</span> <span class="kn">import</span> <span class="n">timeout</span>

<span class="k">def</span> <span class="nf">task_expire</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;echo test expire; date&#39;</span><span class="p">],</span>
            <span class="s">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">timeout</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">))],</span>
            <span class="s">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
           <span class="p">}</span>
</pre></div>
</div>
<p><tt class="docutils literal"><span class="pre">timeout</span></tt> is function that takes an <tt class="docutils literal"><span class="pre">int</span></tt> (seconds) or <tt class="docutils literal"><span class="pre">timedelta</span></tt> as a
parameter. It returns a callable suitable to be used as an <tt class="docutils literal"><span class="pre">uptodate</span></tt> callable.</p>
</div>
<div class="section" id="config-changed">
<h2>config_changed<a class="headerlink" href="#config-changed" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">config_changed</span></tt> is used to check if any &#8220;configuration&#8221; value for the task has
changed. Config values can be a string or dict.</p>
<p>For dict&#8217;s the values are converted to string (actually it uses python&#8217;s <cite>repr()</cite>)
and only a digest/checksum of the dictionaries keys and values are saved.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">doit.tools</span> <span class="kn">import</span> <span class="n">config_changed</span>

<span class="n">option</span> <span class="o">=</span> <span class="s">&quot;AB&quot;</span>
<span class="k">def</span> <span class="nf">task_with_params</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;echo </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">option</span><span class="p">],</span>
            <span class="s">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">config_changed</span><span class="p">(</span><span class="n">option</span><span class="p">)],</span>
            <span class="s">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="check-timestamp-unchanged">
<h2>check_timestamp_unchanged<a class="headerlink" href="#check-timestamp-unchanged" title="Permalink to this headline">¶</a></h2>
<p><tt class="docutils literal"><span class="pre">check_timestamp_unchanged</span></tt> is used to check if specified timestamp of a given
file/dir is unchanged since last run.</p>
<p>The timestamp field to check defaults to <tt class="docutils literal"><span class="pre">mtime</span></tt>, but can be selected by
passing <tt class="docutils literal"><span class="pre">time</span></tt> parameter which can be one of: <tt class="docutils literal"><span class="pre">atime</span></tt>, <tt class="docutils literal"><span class="pre">ctime</span></tt>, <tt class="docutils literal"><span class="pre">mtime</span></tt>
(or their aliases <tt class="docutils literal"><span class="pre">access</span></tt>, <tt class="docutils literal"><span class="pre">status</span></tt>, <tt class="docutils literal"><span class="pre">modify</span></tt>).</p>
<p>Note that <tt class="docutils literal"><span class="pre">ctime</span></tt> or <tt class="docutils literal"><span class="pre">status</span></tt> is platform dependent.
On Unix it is the time of most recent metadata change,
on Windows it is the time of creation.
See <a class="reference external" href="http://docs.python.org/library/os.html#os.stat">Python library documentation for os.stat</a> and Linux man page for
stat(2) for details.</p>
<p>It also accepts an <tt class="docutils literal"><span class="pre">cmp_op</span></tt> parameter which defaults to <tt class="docutils literal"><span class="pre">operator.eq</span></tt> (==).
To use it pass a callable which takes two parameters (prev_time, current_time)
and returns True if task should be considered up-to-date, False otherwise.
Here <tt class="docutils literal"><span class="pre">prev_time</span></tt> is the time from the last successful run and <tt class="docutils literal"><span class="pre">current_time</span></tt>
is the time obtained in current run.</p>
<p>If the specified file does not exist, an exception will be raised.
If a file is a target of another task you should probably add
<tt class="docutils literal"><span class="pre">task_dep</span></tt> on that task to ensure the file is created before it is checked.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">doit.tools</span> <span class="kn">import</span> <span class="n">check_timestamp_unchanged</span>

<span class="k">def</span> <span class="nf">task_create_foo</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;touch foo&#39;</span><span class="p">,</span> <span class="s">&#39;chmod 750 foo&#39;</span><span class="p">],</span>
        <span class="s">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;foo&#39;</span><span class="p">],</span>
        <span class="s">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">True</span><span class="p">],</span>
        <span class="p">}</span>

<span class="k">def</span> <span class="nf">task_on_foo_changed</span><span class="p">():</span>
    <span class="c"># will execute if foo or its metadata is modified</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;echo foo modified&#39;</span><span class="p">],</span>
        <span class="s">&#39;task_dep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;create_foo&#39;</span><span class="p">],</span>
        <span class="s">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">check_timestamp_unchanged</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="s">&#39;ctime&#39;</span><span class="p">)],</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="uptodate-api">
<span id="id2"></span><h2>uptodate API<a class="headerlink" href="#uptodate-api" title="Permalink to this headline">¶</a></h2>
<p>This section will explain how to extend <tt class="docutils literal"><span class="pre">doit</span></tt> writing an <tt class="docutils literal"><span class="pre">uptodate</span></tt>
implementation. So unless you need to write an <tt class="docutils literal"><span class="pre">uptodate</span></tt> implementation
you can skip this.</p>
<p>The callable must take at least two positional parameters <tt class="docutils literal"><span class="pre">task</span></tt> and <tt class="docutils literal"><span class="pre">values</span></tt>.
The callable can also be represented by a tuple (callable, args, kwargs).</p>
<blockquote>
<div><ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">task</span></tt> parameter will give you access to task object. So you have access
to its metadata and opportunity to modify the task itself!</p>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal"><span class="pre">values</span></tt> is a dictionary with the computed values saved in the last</dt>
<dd><p class="first last">successful execution of the task.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>Let&#8217;s start with trivial example.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">fake_get_value_from_db</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">5</span>

<span class="k">def</span> <span class="nf">check_outdated</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">fake_get_value_from_db</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">10</span>


<span class="k">def</span> <span class="nf">task_put_more_stuff_in_db</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">put_stuff</span><span class="p">():</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">put_stuff</span><span class="p">],</span>
            <span class="s">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">check_outdated</span><span class="p">],</span>
            <span class="p">}</span>
</pre></div>
</div>
<p>Note that <cite>check_outdated</cite> function is not actually using the parameters.
You could also execute this function in the task-creator and pass the value
to to <cite>uptodate</cite>. The advantage of just passing the callable is that this
check will not be executed at all if the task was not selected to be executed.</p>
<div class="section" id="example-run-once-implementation">
<h3>Example: run-once implementation<a class="headerlink" href="#example-run-once-implementation" title="Permalink to this headline">¶</a></h3>
<p>Most of the time an <cite>uptodate</cite> implementation will compare the current value
of something with the value it had last time the task was executed.</p>
<p>We already saw how tasks can save values by returning dict on its actions.
But usually the &#8220;value&#8221; we want to check is independent from the task actions.
So the first step is to add a callable to the task so it can save some extra
values. These values are not used by the task itself, they are only used
for dependency checking.</p>
<p>The Task has a property called <tt class="docutils literal"><span class="pre">value_savers</span></tt> that contains a list of
callables. These callables should return a dict that will be saved together
with other task values. The <tt class="docutils literal"><span class="pre">value_savers</span></tt> will be executed after all actions.</p>
<p>The second step is to actually compare the saved value with its &#8220;current&#8221; value.</p>
<p>Let&#8217;s take a look in the <tt class="docutils literal"><span class="pre">run_once</span></tt> implementation.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">save_executed</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;run-once&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
    <span class="n">task</span><span class="o">.</span><span class="n">value_savers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">save_executed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;run-once&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>The function <tt class="docutils literal"><span class="pre">save_executed</span></tt> returns a dict. In this case it is not checking
for any value because it just checks it the task was ever executed.</p>
<p>The next line we use the <tt class="docutils literal"><span class="pre">task</span></tt> parameter adding
<tt class="docutils literal"><span class="pre">save_executed</span></tt> to <tt class="docutils literal"><span class="pre">task.value_savers</span></tt>.So whenever this task is executed this
task value &#8216;run-once&#8217; will be saved.</p>
<p>Finally the return value should be a boolean to indicate if the task is
up-to-date or not. Remember that the &#8216;values&#8217; parameter contains the dict with
the values saved from last successful execution of the task.
So it just checks if this task was executed before by looking for the
<tt class="docutils literal"><span class="pre">run-once</span></tt> entry in <tt class="docutils literal"><span class="pre">`values</span></tt>.</p>
</div>
<div class="section" id="example-timeout-implementation">
<h3>Example: timeout implementation<a class="headerlink" href="#example-timeout-implementation" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s look another example, the <tt class="docutils literal"><span class="pre">timeout</span></tt>. The main difference is that
we actually pass the parameter <tt class="docutils literal"><span class="pre">timeout_limit</span></tt>. Here we present
a simplified version that only accepts integers (seconds) as a parameter.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">timeout</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout_limit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_sec</span> <span class="o">=</span> <span class="n">timeout_limit</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">save_now</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;success-time&#39;</span><span class="p">:</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
        <span class="n">task</span><span class="o">.</span><span class="n">value_savers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">save_now</span><span class="p">)</span>
        <span class="n">last_success</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;success-time&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_success</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_success</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_sec</span>
</pre></div>
</div>
<p>This is a class-based implementation where the objects are made callable
by implementing a <tt class="docutils literal"><span class="pre">__call__</span></tt> method.</p>
<p>On <tt class="docutils literal"><span class="pre">__init__</span></tt> we just save the <tt class="docutils literal"><span class="pre">timeout_limit</span></tt> as an attribute.</p>
<p>The <tt class="docutils literal"><span class="pre">__call__</span></tt> is very similar with the <tt class="docutils literal"><span class="pre">run-once</span></tt> implementation.
First it defines a function (<tt class="docutils literal"><span class="pre">save_now</span></tt>) that is registered
into <tt class="docutils literal"><span class="pre">task.value_savers</span></tt>. Than it compares the current time
with the time that was saved on last successful execution.</p>
</div>
<div class="section" id="example-result-dep-implementation">
<h3>Example: result_dep implementation<a class="headerlink" href="#example-result-dep-implementation" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">result_dep</span></tt> is more complicated due to two factors. It needs to modify
the task&#8217;s <tt class="docutils literal"><span class="pre">task_dep</span></tt>. It needs to check the task&#8217;s saved values and metadata
from a task different from where it is being applied.</p>
<p>A <tt class="docutils literal"><span class="pre">result_dep</span></tt> implies that its dependency is also a <tt class="docutils literal"><span class="pre">task_dep</span></tt>.
We have seen that the callable takes a <cite>task</cite> parameter that we used
to modify the task object. The problem is that modifying <tt class="docutils literal"><span class="pre">task_dep</span></tt>
when the callable gets called would be &#8220;too late&#8221; according to the
way <cite>doit</cite> works. When an object is passed <tt class="docutils literal"><span class="pre">uptodate</span></tt> and this
object&#8217;s class has a method named <tt class="docutils literal"><span class="pre">configure_task</span></tt> it will be called
during the task creation.</p>
<p>The base class <tt class="docutils literal"><span class="pre">dependency.UptodateCalculator</span></tt> gives access to
an attribute named <tt class="docutils literal"><span class="pre">tasks_dict</span></tt> containing a dictionary with
all task objects where the <tt class="docutils literal"><span class="pre">key</span></tt> is the task name (this is used to get all
sub-tasks from a task-group). And also a method called <tt class="docutils literal"><span class="pre">get_val</span></tt> to access
the saved values and results from any task.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">result_dep</span><span class="p">(</span><span class="n">UptodateCalculator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;check if result of the given task was modified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep_task_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dep_name</span> <span class="o">=</span> <span class="n">dep_task_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_name</span> <span class="o">=</span> <span class="s">&#39;_result:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">dep_name</span>

    <span class="k">def</span> <span class="nf">configure_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;to be called by doit when create the task&quot;&quot;&quot;</span>
        <span class="c"># result_dep creates an implicit task_dep</span>
        <span class="n">task</span><span class="o">.</span><span class="n">task_dep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dep_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_result_single</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get result from a single task&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dep_name</span><span class="p">,</span> <span class="s">&#39;result:&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_result_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep_task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;get result from a group task</span>
<span class="sd">        the result is the combination of results of all sub-tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">dep_task</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span>
        <span class="n">sub_tasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">dep_task</span><span class="o">.</span><span class="n">task_dep</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">sub_tasks</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_val</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="s">&#39;result:&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sub_tasks</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return True if result is the same as last run&quot;&quot;&quot;</span>
        <span class="n">dep_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dep_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dep_task</span><span class="o">.</span><span class="n">has_subtask</span><span class="p">:</span>
            <span class="n">dep_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_single</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dep_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result_group</span><span class="p">(</span><span class="n">dep_task</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">value_savers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">result_name</span><span class="p">:</span> <span class="n">dep_result</span><span class="p">})</span>

        <span class="n">last_success</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_success</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">last_success</span> <span class="o">==</span> <span class="n">dep_result</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="cmd_run.html" title="Command line interface - run"
             >next</a></li>
        <li class="right" >
          <a href="dependencies.html" title="More on dependencies"
             >previous</a> |</li>
  <li><a href="index.html">Home</a>&nbsp;|&nbsp;</li>
  <li><a href="contents.html">Documentation</a>&nbsp;|&nbsp;</li>
  <!-- TODO news -->
  <li><a class="external-link" href="https://bitbucket.org/schettino72/doit/src">Code</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://bitbucket.org/schettino72/doit/issues?status=new&status=open">Issues</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://pypi.python.org/pypi/doit">Download</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://groups.google.co.in/group/python-doit">Forum</a></li>
 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Eduardo Schettino.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>