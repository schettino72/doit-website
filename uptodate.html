
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>custom uptodate &#8212; doit - automation tool</title>
    <link rel="stylesheet" href="_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.30',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favico.ico"/>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tools" href="tools.html" />
    <link rel="prev" title="More on Task creation" href="task_creation.html" />
<style>
  body {
    font-size: 16px;
  }

  div.topic {
    padding: 0;
    background-color: #F8F4A6;
    border: 1px solid #D8D486;
  }

  div.topic p.first {
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    background-color: #E8E496;
    border-bottom: 1px solid #C8C476;
  }

  div.topic p {
    margin: 0.5em 1em 0.5em 1em;
  }

  p.topic-title {
    display: run-in;
    margin-right: 15px;
  }

  a.external-link {
    background: url(_static/external.png) center right no-repeat;
    padding-right: 13px;
  }

  div.related ul li a.external-link {
    padding-right: 13px;
  }

  .sidebartext {
    font-size: 75%;
    line-height: 130%;
  }

</style>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29887834-3', 'auto');
  ga('send', 'pageview');
</script>



  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 50px">
<img src="_static/doit.png" alt="doit logo" />
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="tools.html" title="Tools"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="task_creation.html" title="More on Task creation"
             accesskey="P">previous</a> |</li>
  <li><a href="index.html">Home</a>&nbsp;|&nbsp;</li>
  <li><a href="contents.html">Documentation</a>&nbsp;|&nbsp;</li>
  <!-- TODO news -->
  <li><a class="external-link" href="https://github.com/pydoit/doit">Code</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://github.com/pydoit/doit/issues">Issues</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://pypi.python.org/pypi/doit">Download</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://groups.google.co.in/group/python-doit">Forum</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://twitter.com/py_doit">Twitter</a></li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">custom uptodate</a><ul>
<li><a class="reference internal" href="#result-dependency">result-dependency</a></li>
<li><a class="reference internal" href="#run-once">run_once()</a></li>
<li><a class="reference internal" href="#timeout">timeout()</a></li>
<li><a class="reference internal" href="#config-changed">config_changed()</a></li>
<li><a class="reference internal" href="#check-timestamp-unchanged">check_timestamp_unchanged()</a></li>
<li><a class="reference internal" href="#uptodate-api">uptodate API</a><ul>
<li><a class="reference internal" href="#example-run-once-implementation">Example: run-once implementation</a></li>
<li><a class="reference internal" href="#example-timeout-implementation">Example: timeout implementation</a></li>
<li><a class="reference internal" href="#example-result-dep-implementation">Example: result_dep implementation</a></li>
</ul>
</li>
</ul>
</li>
</ul>




<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>




<h3>Donate</h3>


<div>
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" style="margin:auto;">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="GFU3BPVN586A6">
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
<img alt="" border="0" src="https://www.paypalobjects.com/pt_BR/i/scr/pixel.gif" width="1" height="1">
</form>
</div>

<br/>

<div class="sidebartext">
If you use <em>doit</em> and think it is a useful project. Please consider to make a donation to support the developer/maintainer with maintanance tasks (bug fixes, merge patches, reply users) and further development.<br/>
</div>



<h3></h3>
<a href="http://python.org"><img src="_static/python-powered-w-100x40.png" alt="python logo"/></a><br/><br/>

        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="custom-uptodate">
<h1>custom uptodate<a class="headerlink" href="#custom-uptodate" title="Permalink to this headline">¶</a></h1>
<p>The basics of <cite>uptodate</cite> was already <a class="reference internal" href="dependencies.html#attr-uptodate"><span class="std std-ref">introduced</span></a>.
Here we look in more
detail into some implementations shipped with <cite>doit</cite>. And the API used by those.</p>
<div class="section" id="result-dependency">
<span id="result-dep"></span><h2>result-dependency<a class="headerlink" href="#result-dependency" title="Permalink to this headline">¶</a></h2>
<p>In some cases you can not determine if a task is “up-to-date” only based on
input files, the input could come from a database or an external process.
<em>doit</em> defines a “result-dependency” to deal with these cases without need to
create an intermediate file with the results of the process.</p>
<p>i.e. Suppose you want to send an email every time you run <em>doit</em> on a mercurial
repository that contains a new revision number.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">doit.tools</span> <span class="k">import</span> <span class="n">result_dep</span>

<span class="k">def</span> <span class="nf">task_version</span><span class="p">():</span>
	<span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;hg tip --template &#39;</span><span class="si">{rev}</span><span class="s2">:</span><span class="si">{node}</span><span class="s2">&#39;&quot;</span><span class="p">]}</span>

<span class="k">def</span> <span class="nf">task_send_email</span><span class="p">():</span>
	<span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;echo &quot;TODO: send an email&quot;&#39;</span><span class="p">],</span>
	        <span class="s1">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">result_dep</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)]}</span>
</pre></div>
</div>
<p>Note the <cite>result_dep</cite> with the name of the task (‘version’). <cite>doit</cite> will keep
track of the output of the task <em>version</em> and will execute <em>send_email</em> only
when the mercurial repository has a new version since last
time <em>doit</em> was executed.</p>
<p>The “result” from the dependent task compared between different runs is given
by its last action.
The content for python-action is the value of the returned string or dict.
For cmd-actions it is the output send to stdout plus stderr.</p>
<p><cite>result_dep</cite> also supports group-tasks. In this case it will check that the
result of all subtasks did not change. And also the existing sub-tasks are
the same.</p>
</div>
<div class="section" id="run-once">
<span id="id1"></span><h2>run_once()<a class="headerlink" href="#run-once" title="Permalink to this headline">¶</a></h2>
<p>Sometimes there is no dependency for a task but you do not want to execute it
all the time. With “run_once” the task will not be executed again after the first
successful run. This is mostly used together with targets.</p>
<p>Suppose you need to download something from internet.
There is no dependency, but you do not want to download it many times.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">doit.tools</span> <span class="k">import</span> <span class="n">run_once</span>

<span class="k">def</span> <span class="nf">task_get_pylogo</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://python.org/images/python-logo.gif&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;wget </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">],</span>
            <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;python-logo.gif&quot;</span><span class="p">],</span>
            <span class="s1">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">run_once</span><span class="p">],</span>
            <span class="p">}</span>
</pre></div>
</div>
<p>Note that even with <em>run_once</em> the file will be downloaded again in case the target is removed.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> doit
<span class="go">.  get_pylogo</span>
<span class="gp">$</span> doit
<span class="go">-- get_pylogo</span>
<span class="gp">$</span> rm python-logo.gif
<span class="gp">$</span> doit
<span class="go">.  get_pylogo</span>
</pre></div>
</div>
</div>
<div class="section" id="timeout">
<span id="id2"></span><h2>timeout()<a class="headerlink" href="#timeout" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">timeout</span></code> is used to expire a task after a certain time interval.</p>
<p>i.e. You want to re-execute a task only if the time elapsed since the last
time it was executed is bigger than 5 minutes.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">doit.tools</span> <span class="k">import</span> <span class="n">timeout</span>

<span class="k">def</span> <span class="nf">task_expire</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;echo test expire; date&#39;</span><span class="p">],</span>
            <span class="s1">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">timeout</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">))],</span>
            <span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
           <span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">timeout</span></code> is function that takes an <code class="docutils literal"><span class="pre">int</span></code> (seconds) or <code class="docutils literal"><span class="pre">timedelta</span></code> as a
parameter. It returns a callable suitable to be used as an <code class="docutils literal"><span class="pre">uptodate</span></code> callable.</p>
</div>
<div class="section" id="config-changed">
<span id="id3"></span><h2>config_changed()<a class="headerlink" href="#config-changed" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">config_changed</span></code> is used to check if any “configuration” value for the task has
changed. Config values can be a string or dict.</p>
<p>For dict’s the values are converted to string (actually it uses python’s <cite>repr()</cite>)
and only a digest/checksum of the dictionaries keys and values are saved.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">doit.tools</span> <span class="k">import</span> <span class="n">config_changed</span>

<span class="n">option</span> <span class="o">=</span> <span class="s2">&quot;AB&quot;</span>
<span class="k">def</span> <span class="nf">task_with_params</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;echo </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">option</span><span class="p">],</span>
            <span class="s1">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">config_changed</span><span class="p">(</span><span class="n">option</span><span class="p">)],</span>
            <span class="s1">&#39;verbosity&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="check-timestamp-unchanged">
<span id="id4"></span><h2>check_timestamp_unchanged()<a class="headerlink" href="#check-timestamp-unchanged" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">check_timestamp_unchanged</span></code> is used to check if specified timestamp of a given
file/dir is unchanged since last run.</p>
<p>The timestamp field to check defaults to <code class="docutils literal"><span class="pre">mtime</span></code>, but can be selected by
passing <code class="docutils literal"><span class="pre">time</span></code> parameter which can be one of: <code class="docutils literal"><span class="pre">atime</span></code>, <code class="docutils literal"><span class="pre">ctime</span></code>, <code class="docutils literal"><span class="pre">mtime</span></code>
(or their aliases <code class="docutils literal"><span class="pre">access</span></code>, <code class="docutils literal"><span class="pre">status</span></code>, <code class="docutils literal"><span class="pre">modify</span></code>).</p>
<p>Note that <code class="docutils literal"><span class="pre">ctime</span></code> or <code class="docutils literal"><span class="pre">status</span></code> is platform dependent.
On Unix it is the time of most recent metadata change,
on Windows it is the time of creation.
See <a class="reference external" href="http://docs.python.org/library/os.html#os.stat">Python library documentation for os.stat</a> and Linux man page for
stat(2) for details.</p>
<p>It also accepts an <code class="docutils literal"><span class="pre">cmp_op</span></code> parameter which defaults to <code class="docutils literal"><span class="pre">operator.eq</span></code> (==).
To use it pass a callable which takes two parameters (prev_time, current_time)
and returns True if task should be considered up-to-date, False otherwise.
Here <code class="docutils literal"><span class="pre">prev_time</span></code> is the time from the last successful run and <code class="docutils literal"><span class="pre">current_time</span></code>
is the time obtained in current run.</p>
<p>If the specified file does not exist, an exception will be raised.
If a file is a target of another task you should probably add
<code class="docutils literal"><span class="pre">task_dep</span></code> on that task to ensure the file is created before it is checked.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">doit.tools</span> <span class="k">import</span> <span class="n">check_timestamp_unchanged</span>

<span class="k">def</span> <span class="nf">task_create_foo</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;touch foo&#39;</span><span class="p">,</span> <span class="s1">&#39;chmod 750 foo&#39;</span><span class="p">],</span>
        <span class="s1">&#39;targets&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">],</span>
        <span class="s1">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">True</span><span class="p">],</span>
        <span class="p">}</span>

<span class="k">def</span> <span class="nf">task_on_foo_changed</span><span class="p">():</span>
    <span class="c1"># will execute if foo or its metadata is modified</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;echo foo modified&#39;</span><span class="p">],</span>
        <span class="s1">&#39;task_dep&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;create_foo&#39;</span><span class="p">],</span>
        <span class="s1">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">check_timestamp_unchanged</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;ctime&#39;</span><span class="p">)],</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="uptodate-api">
<span id="id6"></span><h2>uptodate API<a class="headerlink" href="#uptodate-api" title="Permalink to this headline">¶</a></h2>
<p>This section will explain how to extend <code class="docutils literal"><span class="pre">doit</span></code> writing an <code class="docutils literal"><span class="pre">uptodate</span></code>
implementation. So unless you need to write an <code class="docutils literal"><span class="pre">uptodate</span></code> implementation
you can skip this.</p>
<p>Let’s start with trivial example. <cite>uptodate</cite> is a function that returns
a boolean value.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">fake_get_value_from_db</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">5</span>

<span class="k">def</span> <span class="nf">check_outdated</span><span class="p">():</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">fake_get_value_from_db</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">10</span>


<span class="k">def</span> <span class="nf">task_put_more_stuff_in_db</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">put_stuff</span><span class="p">():</span> <span class="k">pass</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;actions&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">put_stuff</span><span class="p">],</span>
            <span class="s1">&#39;uptodate&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">check_outdated</span><span class="p">],</span>
            <span class="p">}</span>
</pre></div>
</div>
<p>You could also execute this function in the task-creator and pass the value
to to <cite>uptodate</cite>. The advantage of just passing the callable is that this
check will not be executed at all if the task was not selected to be executed.</p>
<div class="section" id="example-run-once-implementation">
<h3>Example: run-once implementation<a class="headerlink" href="#example-run-once-implementation" title="Permalink to this headline">¶</a></h3>
<p>Most of the time an <cite>uptodate</cite> implementation will compare the current value
of something with the value it had last time the task was executed.</p>
<p>We already saw how tasks can save values by returning dict on its actions.
But usually the “value” we want to check is independent from the task actions.
So the first step is to add a callable to the task so it can save some extra
values. These values are not used by the task itself, they are only used
for dependency checking.</p>
<p>The Task has a property called <code class="docutils literal"><span class="pre">value_savers</span></code> that contains a list of
callables. These callables should return a dict that will be saved together
with other task values. The <code class="docutils literal"><span class="pre">value_savers</span></code> will be executed after all actions.</p>
<p>The second step is to actually compare the saved value with its “current” value.</p>
<p>The <cite>uptodate</cite> callable can take two positional parameters <code class="docutils literal"><span class="pre">task</span></code> and <code class="docutils literal"><span class="pre">values</span></code>. The callable can also be represented by a tuple (callable, args, kwargs).</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">task</span></code> parameter will give you access to task object. So you have access
to its metadata and opportunity to modify the task itself!</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">values</span></code> is a dictionary with the computed values saved in the last</dt>
<dd>successful execution of the task.</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>Let’s take a look in the <code class="docutils literal"><span class="pre">run_once</span></code> implementation.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">save_executed</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;run-once&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="n">task</span><span class="o">.</span><span class="n">value_savers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">save_executed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;run-once&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>The function <code class="docutils literal"><span class="pre">save_executed</span></code> returns a dict. In this case it is not checking
for any value because it just checks it the task was ever executed.</p>
<p>The next line we use the <code class="docutils literal"><span class="pre">task</span></code> parameter adding
<code class="docutils literal"><span class="pre">save_executed</span></code> to <code class="docutils literal"><span class="pre">task.value_savers</span></code>.So whenever this task is executed this
task value ‘run-once’ will be saved.</p>
<p>Finally the return value should be a boolean to indicate if the task is
up-to-date or not. Remember that the ‘values’ parameter contains the dict with
the values saved from last successful execution of the task.
So it just checks if this task was executed before by looking for the
<code class="docutils literal"><span class="pre">run-once</span></code> entry in <code class="docutils literal"><span class="pre">`values</span></code>.</p>
</div>
<div class="section" id="example-timeout-implementation">
<h3>Example: timeout implementation<a class="headerlink" href="#example-timeout-implementation" title="Permalink to this headline">¶</a></h3>
<p>Let’s look another example, the <code class="docutils literal"><span class="pre">timeout</span></code>. The main difference is that
we actually pass the parameter <code class="docutils literal"><span class="pre">timeout_limit</span></code>. Here we present
a simplified version that only accepts integers (seconds) as a parameter.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">timeout</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout_limit</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_sec</span> <span class="o">=</span> <span class="n">timeout_limit</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">save_now</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;success-time&#39;</span><span class="p">:</span> <span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
        <span class="n">task</span><span class="o">.</span><span class="n">value_savers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">save_now</span><span class="p">)</span>
        <span class="n">last_success</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success-time&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last_success</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">time_module</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_success</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_sec</span>
</pre></div>
</div>
<p>This is a class-based implementation where the objects are made callable
by implementing a <code class="docutils literal"><span class="pre">__call__</span></code> method.</p>
<p>On <code class="docutils literal"><span class="pre">__init__</span></code> we just save the <code class="docutils literal"><span class="pre">timeout_limit</span></code> as an attribute.</p>
<p>The <code class="docutils literal"><span class="pre">__call__</span></code> is very similar with the <code class="docutils literal"><span class="pre">run-once</span></code> implementation.
First it defines a function (<code class="docutils literal"><span class="pre">save_now</span></code>) that is registered
into <code class="docutils literal"><span class="pre">task.value_savers</span></code>. Than it compares the current time
with the time that was saved on last successful execution.</p>
</div>
<div class="section" id="example-result-dep-implementation">
<h3>Example: result_dep implementation<a class="headerlink" href="#example-result-dep-implementation" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">result_dep</span></code> is more complicated due to two factors. It needs to modify
the task’s <code class="docutils literal"><span class="pre">task_dep</span></code>.
And it needs to check the task’s saved values and metadata
from a task different from where it is being applied.</p>
<p>A <code class="docutils literal"><span class="pre">result_dep</span></code> implies that its dependency is also a <code class="docutils literal"><span class="pre">task_dep</span></code>.
We have seen that the callable takes a <cite>task</cite> parameter that we used
to modify the task object. The problem is that modifying <code class="docutils literal"><span class="pre">task_dep</span></code>
when the callable gets called would be “too late” according to the
way <cite>doit</cite> works. When an object is passed <code class="docutils literal"><span class="pre">uptodate</span></code> and this
object’s class has a method named <code class="docutils literal"><span class="pre">configure_task</span></code> it will be called
during the task creation.</p>
<p>The base class <code class="docutils literal"><span class="pre">dependency.UptodateCalculator</span></code> gives access to
an attribute named <code class="docutils literal"><span class="pre">tasks_dict</span></code> containing a dictionary with
all task objects where the <code class="docutils literal"><span class="pre">key</span></code> is the task name (this is used to get all
sub-tasks from a task-group). And also a method called <code class="docutils literal"><span class="pre">get_val</span></code> to access
the saved values and results from any task.</p>
<p>See the <cite>result_dep</cite> <a class="reference external" href="https://github.com/pydoit/doit/blob/master/doit/task.py">source</a>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="tools.html" title="Tools"
             >next</a></li>
        <li class="right" >
          <a href="task_creation.html" title="More on Task creation"
             >previous</a> |</li>
  <li><a href="index.html">Home</a>&nbsp;|&nbsp;</li>
  <li><a href="contents.html">Documentation</a>&nbsp;|&nbsp;</li>
  <!-- TODO news -->
  <li><a class="external-link" href="https://github.com/pydoit/doit">Code</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://github.com/pydoit/doit/issues">Issues</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://pypi.python.org/pypi/doit">Download</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="http://groups.google.co.in/group/python-doit">Forum</a>&nbsp;|&nbsp;</li>
  <li><a class="external-link" href="https://twitter.com/py_doit">Twitter</a></li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2008-2015, Eduardo Schettino.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.6.
    </div>
  </body>
</html>